<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokédex | Gen 1-9 Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Fredoka', sans-serif; background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #dc2626; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #b91c1c; }
        .poke-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .poke-card:hover { transform: translateY(-4px); box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.1); }
        @keyframes fillBar { from { width: 0%; } }
        .stat-bar-fill { animation: fillBar 0.6s ease-out forwards; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .form-btn.active { background-color: white; color: #ef4444; border-color: white; }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex flex-col">

    <header class="bg-red-600 text-white shadow-lg z-20 flex-none">
        <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col lg:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-3 w-full lg:w-auto justify-center lg:justify-start">
                <div class="bg-white rounded-full p-1 border-4 border-blue-200 shadow-inner">
                    <div class="w-8 h-8 bg-blue-500 rounded-full shadow-inner animate-pulse"></div>
                </div>
                <div>
                    <h1 class="text-3xl font-bold tracking-wider leading-none">POKÉDEX</h1>
                    <span class="text-red-200 text-xs font-medium tracking-widest block">GEN 1-9 • DATA DRIVEN</span>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2 w-full lg:w-auto items-center justify-center">
                
                <select id="genSelect" class="bg-white text-gray-800 px-4 py-2 rounded-full shadow-md focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm font-bold cursor-pointer">
                    <option value="all">All Gens</option>
                    <option value="gen1">Gen 1 (Kanto)</option>
                    <option value="gen2">Gen 2 (Johto)</option>
                    <option value="gen3">Gen 3 (Hoenn)</option>
                    <option value="gen4">Gen 4 (Sinnoh)</option>
                    <option value="gen5">Gen 5 (Unova)</option>
                    <option value="gen6">Gen 6 (Kalos)</option>
                    <option value="gen7">Gen 7 (Alola)</option>
                    <option value="gen8">Gen 8 (Galar)</option>
                    <option value="gen9">Gen 9 (Paldea)</option>
                </select>

                <div class="relative flex-grow md:flex-grow-0 min-w-[180px]">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="searchInput" placeholder="Search..." 
                        class="w-full pl-10 pr-4 py-2 rounded-full text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-400 shadow-md">
                </div>
                
                <div class="flex bg-white rounded-full shadow-md p-1">
                    <select id="sortSelect" class="bg-transparent px-3 py-1 rounded-full text-gray-800 focus:outline-none text-sm cursor-pointer font-medium">
                        <option value="id"># ID</option>
                        <option value="name">Name</option>
                        <option value="total">BST (Total)</option>
                        <option value="hp">HP</option>
                        <option value="attack">Attack</option>
                        <option value="defense">Defense</option>
                        <option value="special-attack">Sp. Atk</option>
                        <option value="special-defense">Sp. Def</option>
                        <option value="speed">Speed</option>
                    </select>
                    <button id="sortOrderBtn" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition-colors" title="Toggle Asc/Desc">
                        <i class="fas fa-sort-numeric-down"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-red-700 py-2 overflow-x-auto no-scrollbar">
            <div class="max-w-7xl mx-auto px-4 flex gap-2 min-w-max" id="typeFilters">
                </div>
        </div>
    </header>

    <main class="flex-grow overflow-y-auto relative bg-gray-100 p-4" id="mainContainer">
        
        <div id="loadingScreen" class="absolute inset-0 bg-gray-100 z-10 flex flex-col items-center justify-center">
            <div class="relative">
                <div class="w-20 h-20 border-8 border-gray-200 rounded-full"></div>
                <div class="w-20 h-20 border-8 border-red-500 rounded-full animate-spin absolute top-0 border-t-transparent"></div>
            </div>
            <h2 class="text-2xl font-bold text-gray-600 mt-4">Downloading Database...</h2>
            <p class="text-gray-400 text-sm mt-2">Fetching stats for 1000+ Pokémon</p>
        </div>

        <div id="pokemonGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-5 max-w-7xl mx-auto hidden pb-20"></div>
        
        <div id="scrollSentinel" class="h-20 w-full flex items-center justify-center opacity-0"></div>

        <div id="noResults" class="hidden flex-col items-center justify-center mt-20 opacity-50">
            <i class="fas fa-ghost text-6xl mb-4"></i>
            <p class="text-xl">No Pokémon found matching criteria.</p>
        </div>
    </main>

    <div id="modalOverlay" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div id="modalContent" class="glass-panel w-full max-w-5xl rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300 flex flex-col md:flex-row max-h-[90vh]">
            
            <div id="modalHeader" class="md:w-5/12 p-6 flex flex-col items-center justify-between text-white relative overflow-hidden transition-colors duration-500">
                <div class="absolute inset-0 bg-black opacity-10 pattern-dots"></div>
                
                <div class="relative z-10 w-full text-center">
                    <h2 id="modalName" class="text-4xl font-bold capitalize mb-1">Name</h2>
                    <span id="modalId" class="text-lg opacity-80 font-mono">#000</span>
                    <div id="modalFormName" class="text-sm font-bold uppercase tracking-widest opacity-70 mt-1 min-h-[20px]"></div>
                </div>

                <div class="relative w-64 h-64 my-4 z-10 flex items-center justify-center">
                    <img id="modalImg" src="" alt="Pokemon" class="w-full h-full object-contain filter drop-shadow-2xl transition-all duration-300">
                </div>

                <div id="formSelectorContainer" class="relative z-10 w-full overflow-x-auto pb-2 hidden">
                    <div id="formButtons" class="flex justify-center gap-2 px-2 min-w-max"></div>
                </div>

                <div id="modalTypes" class="flex gap-2 mt-4 relative z-10 flex-wrap justify-center"></div>
            </div>

            <div class="md:w-7/12 p-6 md:p-8 bg-white overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 border-b-2 border-gray-200 pb-1">Base Stats</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-red-500 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <div class="space-y-4" id="modalStats"></div>

                <div class="mt-8 pt-6 border-t border-gray-100 flex justify-between items-center">
                    <div class="text-center">
                        <span class="block text-sm text-gray-500 uppercase font-bold">Total</span>
                        <span id="modalTotal" class="text-3xl font-bold text-blue-600">0</span>
                    </div>
                    <div class="text-right text-xs text-gray-400">
                        *Stats for currently selected form
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const TYPE_COLORS = {
            normal: '#A8A77A', fire: '#EE8130', water: '#6390F0', electric: '#F7D02C',
            grass: '#7AC74C', ice: '#96D9D6', fighting: '#C22E28', poison: '#A33EA1',
            ground: '#E2BF65', flying: '#A98FF3', psychic: '#F95587', bug: '#A6B91A',
            rock: '#B6A136', ghost: '#735797', dragon: '#6F35FC', steel: '#B7B7CE',
            fairy: '#D685AD', dark: '#705746'
        };

        const STAT_LABELS = { hp: 'HP', attack: 'Atk', defense: 'Def', 'special-attack': 'SpA', 'special-defense': 'SpD', speed: 'Spe' };
        
        // Gen Ranges
        const GEN_RANGES = {
            gen1: [1, 151], gen2: [152, 251], gen3: [252, 386], 
            gen4: [387, 493], gen5: [494, 649], gen6: [650, 721], 
            gen7: [722, 809], gen8: [810, 905], gen9: [906, 1025]
        };

        // Data Storage
        let basePokemon = [];   // IDs 1-1025 (The Main Grid)
        let formPokemon = [];   // IDs > 10000 (Megas, Gmax, etc.)
        let displayList = [];   // Currently filtered list
        let loadedCount = 0;    // Infinite scroll tracker
        
        // Filters
        let currentFilter = {
            term: '',
            type: 'all',
            gen: 'all',
            sort: 'id',
            asc: true
        };

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            renderTypeFilters();
            setupEvents();
        });

        // --- 1. Fetching Data (GraphQL Strategy) ---
        async function initApp() {
            try {
                const query = `
                query {
                    pokemon_v2_pokemon {
                        id
                        name
                        pokemon_v2_pokemontypes {
                            pokemon_v2_type { name }
                        }
                        pokemon_v2_pokemonstats {
                            base_stat
                            pokemon_v2_stat { name }
                        }
                    }
                }`;

                const response = await fetch('https://beta.pokeapi.co/graphql/v1beta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });

                const json = await response.json();
                const rawData = json.data.pokemon_v2_pokemon;

                // Process Data
                rawData.forEach(p => {
                    const stats = {};
                    let total = 0;
                    p.pokemon_v2_pokemonstats.forEach(s => {
                        stats[s.pokemon_v2_stat.name] = s.base_stat;
                        total += s.base_stat;
                    });

                    const types = p.pokemon_v2_pokemontypes.map(t => t.pokemon_v2_type.name);
                    const img = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${p.id}.png`;

                    const pokeObj = {
                        id: p.id,
                        name: p.name,
                        types: types,
                        stats: stats,
                        total: total,
                        img: img
                    };

                    if (p.id <= 1025) {
                        basePokemon.push(pokeObj);
                    } else {
                        formPokemon.push(pokeObj);
                    }
                });

                basePokemon.sort((a,b) => a.id - b.id);

                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('pokemonGrid').classList.remove('hidden');
                
                applyFilters();
                setupIntersectionObserver();

            } catch (error) {
                console.error("GraphQL Error:", error);
                document.querySelector('#loadingScreen h2').innerText = "Error Loading Data";
            }
        }

        // --- 2. Filtering & Sorting ---
        function applyFilters() {
            // Filter
            let result = basePokemon.filter(p => {
                if (currentFilter.gen !== 'all') {
                    const [min, max] = GEN_RANGES[currentFilter.gen];
                    if (p.id < min || p.id > max) return false;
                }
                if (currentFilter.type !== 'all') {
                    if (!p.types.includes(currentFilter.type)) return false;
                }
                if (currentFilter.term) {
                    if (!p.name.includes(currentFilter.term) && !p.id.toString().includes(currentFilter.term)) return false;
                }
                return true;
            });

            // Sort
            const sortKey = currentFilter.sort;
            const m = currentFilter.asc ? 1 : -1;

            result.sort((a, b) => {
                let valA, valB;

                if (sortKey === 'id') {
                    valA = a.id; valB = b.id;
                } else if (sortKey === 'name') {
                    return currentFilter.asc ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
                } else if (sortKey === 'total') {
                    valA = a.total; valB = b.total;
                } else {
                    valA = a.stats[sortKey] || 0;
                    valB = b.stats[sortKey] || 0;
                }

                return (valA - valB) * m;
            });

            displayList = result;
            loadedCount = 0;
            document.getElementById('pokemonGrid').innerHTML = '';
            
            if (displayList.length === 0) {
                document.getElementById('noResults').classList.remove('hidden');
                document.getElementById('noResults').classList.add('flex');
            } else {
                document.getElementById('noResults').classList.add('hidden');
                document.getElementById('noResults').classList.remove('flex');
                loadBatch(50);
            }
        }

        // --- 3. Rendering ---
        function loadBatch(amt) {
            const batch = displayList.slice(loadedCount, loadedCount + amt);
            if (batch.length === 0) return;

            const fragment = document.createDocumentFragment();

            batch.forEach(poke => {
                const mainType = poke.types[0];
                const color = TYPE_COLORS[mainType];
                
                const el = document.createElement('div');
                el.className = 'poke-card bg-white rounded-xl overflow-hidden shadow-md cursor-pointer relative';
                el.onclick = () => openModal(poke);
                
                // Determine preview label for stats
                let statPreview = '';
                if (currentFilter.sort !== 'id' && currentFilter.sort !== 'name') {
                    const label = currentFilter.sort === 'total' ? 'BST' : STAT_LABELS[currentFilter.sort];
                    const val = currentFilter.sort === 'total' ? poke.total : poke.stats[currentFilter.sort];
                    statPreview = `<div class="mt-2 text-xs font-bold text-gray-500 uppercase tracking-wider bg-gray-50 rounded py-1">${label}: <span class="text-gray-800 text-sm ml-1">${val}</span></div>`;
                }

                el.innerHTML = `
                    <div class="h-24 w-full relative" style="background-color: ${color}20;">
                        <span class="absolute top-2 right-3 text-3xl font-black text-slate-900 opacity-5">#${poke.id}</span>
                    </div>
                    <div class="px-4 pb-4 relative">
                        <div class="w-28 h-28 mx-auto -mt-16 relative z-10">
                            <img src="${poke.img}" alt="${poke.name}" loading="lazy" class="w-full h-full object-contain filter drop-shadow-md">
                        </div>
                        <div class="text-center mt-2">
                            <h3 class="text-lg font-bold text-gray-800 capitalize leading-tight truncate">${poke.name}</h3>
                            <div class="flex justify-center gap-1 mt-2">
                                ${poke.types.map(t => `<span class="px-2 py-0.5 rounded text-[10px] font-bold text-white uppercase" style="background-color: ${TYPE_COLORS[t]}">${t}</span>`).join('')}
                            </div>
                            ${statPreview}
                        </div>
                    </div>
                `;
                fragment.appendChild(el);
            });

            document.getElementById('pokemonGrid').appendChild(fragment);
            loadedCount += amt;
        }

        function setupIntersectionObserver() {
            const observer = new IntersectionObserver(entries => {
                if (entries[0].isIntersecting) loadBatch(30);
            }, { rootMargin: '400px' });
            observer.observe(document.getElementById('scrollSentinel'));
        }

        // --- 4. Modal Logic (Forms & Gimmicks) ---
        function openModal(poke) {
            const modal = document.getElementById('modalOverlay');
            modal.classList.remove('hidden');

            const forms = formPokemon.filter(f => f.name.startsWith(poke.name + '-'));
            
            const btnContainer = document.getElementById('formButtons');
            btnContainer.innerHTML = '';
            
            if (forms.length > 0) {
                document.getElementById('formSelectorContainer').classList.remove('hidden');
                btnContainer.appendChild(createFormBtn('Base', poke, true));
                forms.forEach(f => {
                    const label = f.name.replace(poke.name + '-', '').replace(/-/g, ' ');
                    btnContainer.appendChild(createFormBtn(label, f, false));
                });
            } else {
                document.getElementById('formSelectorContainer').classList.add('hidden');
            }

            renderModalContent(poke);

            setTimeout(() => {
                modal.classList.remove('opacity-0');
                document.getElementById('modalContent').classList.remove('scale-95');
                document.getElementById('modalContent').classList.add('scale-100');
            }, 10);
        }

        function createFormBtn(label, data, active) {
            const btn = document.createElement('button');
            btn.className = `form-btn px-3 py-1 rounded border border-white/40 text-xs font-bold uppercase transition-all hover:bg-white/20 text-white whitespace-nowrap ${active ? 'active' : ''}`;
            btn.innerText = label;
            btn.onclick = () => {
                document.querySelectorAll('.form-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderModalContent(data);
            };
            return btn;
        }

        function renderModalContent(data) {
            const color = TYPE_COLORS[data.types[0]];
            document.getElementById('modalHeader').style.backgroundColor = color;
            
            const baseName = data.name.split('-')[0];
            const suffix = data.name.includes('-') ? data.name.substring(data.name.indexOf('-')+1).replace(/-/g, ' ') : '';

            document.getElementById('modalName').innerText = baseName;
            document.getElementById('modalFormName').innerText = suffix;
            document.getElementById('modalId').innerText = `#${data.id}`;
            document.getElementById('modalImg').src = data.img;
            document.getElementById('modalTotal').innerText = data.total;

            document.getElementById('modalTypes').innerHTML = data.types.map(t => 
                `<span class="px-4 py-1 rounded-full text-sm font-bold uppercase shadow-sm bg-white bg-opacity-30 border border-white border-opacity-40">${t}</span>`
            ).join('');

            const maxStat = 255;
            document.getElementById('modalStats').innerHTML = Object.entries(data.stats).map(([key, val]) => {
                const label = STAT_LABELS[key] || key;
                const percent = Math.min((val/maxStat)*100, 100);
                let barColor = 'bg-red-500';
                if(val >= 60) barColor = 'bg-orange-400';
                if(val >= 90) barColor = 'bg-yellow-400';
                if(val >= 110) barColor = 'bg-green-500';
                if(val >= 140) barColor = 'bg-cyan-500';

                return `
                    <div class="flex items-center text-sm mb-2">
                        <div class="w-10 font-bold text-gray-400 text-xs uppercase">${label}</div>
                        <div class="w-8 font-bold text-gray-700 text-right mr-3">${val}</div>
                        <div class="flex-grow h-2.5 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full rounded-full ${barColor} stat-bar-fill" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.add('opacity-0');
            document.getElementById('modalContent').classList.remove('scale-100');
            setTimeout(() => {
                document.getElementById('modalOverlay').classList.add('hidden');
            }, 300);
        }

        // --- 5. UI Helpers ---
        function renderTypeFilters() {
            const container = document.getElementById('typeFilters');
            const allBtn = document.createElement('button');
            allBtn.className = 'px-4 py-1 rounded-full text-white text-sm font-bold uppercase transition-transform hover:scale-105 filter-btn ring-2 ring-white';
            allBtn.style.backgroundColor = '#4b5563';
            allBtn.innerText = 'All';
            allBtn.onclick = () => setType('all', allBtn);
            container.appendChild(allBtn);

            Object.entries(TYPE_COLORS).forEach(([type, color]) => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-1 rounded-full text-white text-sm font-bold uppercase transition-transform hover:scale-105 filter-btn opacity-80 hover:opacity-100';
                btn.style.backgroundColor = color;
                btn.innerText = type;
                btn.onclick = () => setType(type, btn);
                container.appendChild(btn);
            });
        }

        function setType(type, btn) {
            currentFilter.type = type;
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('ring-2', 'ring-white', 'opacity-100');
                b.classList.add('opacity-80');
            });
            btn.classList.remove('opacity-80');
            btn.classList.add('ring-2', 'ring-white', 'opacity-100');
            applyFilters();
        }

        function setupEvents() {
            document.getElementById('genSelect').addEventListener('change', (e) => {
                currentFilter.gen = e.target.value;
                applyFilters();
            });
            document.getElementById('searchInput').addEventListener('input', (e) => {
                currentFilter.term = e.target.value.toLowerCase();
                applyFilters();
            });
            document.getElementById('sortSelect').addEventListener('change', (e) => {
                currentFilter.sort = e.target.value;
                applyFilters();
            });
            document.getElementById('sortOrderBtn').addEventListener('click', () => {
                currentFilter.asc = !currentFilter.asc;
                document.getElementById('sortOrderBtn').querySelector('i').className = currentFilter.asc ? 'fas fa-sort-numeric-down' : 'fas fa-sort-numeric-up';
                applyFilters();
            });
            document.getElementById('modalOverlay').addEventListener('click', (e) => {
                if (e.target.id === 'modalOverlay') closeModal();
            });
        }
    </script>
</body>
</html>
