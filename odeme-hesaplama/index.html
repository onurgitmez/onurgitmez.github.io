<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Ödeme Hesaplama · Contract Remainder Calculator</title>
    <meta name="color-scheme" content="dark">

    <!-- Tailwind (runtime) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 + ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for in-page JSX (keeps this single-file) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      const { useMemo, useState } = React;

      function App() {
        const todayISO = new Date().toISOString().slice(0, 10);

        const [amount, setAmount] = useState("");
        const [years, setYears]   = useState(1);
        const [saleDate, setSaleDate] = useState(todayISO);
        const [asOfDate, setAsOfDate] = useState(todayISO);
        const [currency, setCurrency] = useState("TRY");

        function parseISO(d) {
          const [y,m,day] = d.split("-").map(Number);
          return new Date(Date.UTC(y, (m||1)-1, day||1));
        }
        function addYears(date, y) {
          const d = new Date(date.getTime());
          d.setUTCFullYear(d.getUTCFullYear() + y);
          return d;
        }
        function diffDays(start, end) {
          const MS = 24*60*60*1000;
          const a = Date.UTC(start.getUTCFullYear(), start.getUTCMonth(), start.getUTCDate());
          const b = Date.UTC(end.getUTCFullYear(),   end.getUTCMonth(),   end.getUTCDate());
          return Math.floor((b - a) / MS); // non-inclusive of end day
        }

        const result = useMemo(() => {
          const amountNum = Number((amount || "").toString().replace(/[^0-9.,-]/g, "").replace(/,/g, "."));
          if (!saleDate || !asOfDate || !years || !amountNum || amountNum < 0 || years < 1) return null;

          const sale = parseISO(saleDate);
          const asof = parseISO(asOfDate);
          const end  = addYears(sale, Math.floor(years));

          const totalDays = Math.max(0, diffDays(sale, end));
          const elapsedRaw = diffDays(sale, asof);
          const elapsed = Math.min(Math.max(0, elapsedRaw), totalDays);
          const remainingDays = Math.max(0, totalDays - elapsed);

          const dailyRate = totalDays > 0 ? amountNum / totalDays : 0;
          const recognized = dailyRate * elapsed;
          const remaining = Math.max(0, amountNum - recognized);

          return { totalDays, elapsed, remainingDays, dailyRate, recognized, remaining, endDate: end, sale, asof, amountNum };
        }, [amount, years, saleDate, asOfDate]);

        const fmt = new Intl.NumberFormat(currency === "TRY" ? "tr-TR" : undefined, {
          style: "currency", currency, maximumFractionDigits: 0
        });

        const fmtNum = new Intl.NumberFormat(currency === "TRY" ? "tr-TR" : undefined, {
          maximumFractionDigits: 0
        });

        function pct(n, d) { if (d <= 0) return 0; return Math.min(100, Math.max(0, (n / d) * 100)); }

        return (
          <div className="min-h-screen w-full bg-gradient-to-br from-slate-950 via-slate-900 to-slate-800 text-slate-100">
            <header className="px-6 pt-8 pb-4">
              <h1 className="text-3xl md:text-4xl font-semibold tracking-tight">Contract Remainder Calculator</h1>
              <p className="text-slate-300 mt-2">Satış tarihi, sözleşme süresi (yıl) ve tutarı girin. Uygulama gün bazında (artı sıçrama yılları) doğrusal paylaştırma ile kalan/gelirleşen tutarı hesaplar.</p>
            </header>

            <main className="px-6 pb-12 grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
              <section className="lg:col-span-1">
                <div className="backdrop-blur-xl bg-white/5 border border-white/10 rounded-2xl p-5 shadow-2xl shadow-black/30">
                  <h2 className="text-lg font-medium mb-4">Girdiler</h2>

                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm text-slate-300 mb-1" htmlFor="amount">Satış Tutarı</label>
                      <div className="flex gap-2">
                        <input id="amount" type="number" min="0" inputMode="decimal" placeholder="örn. 365000"
                          value={amount} onChange={(e) => setAmount(e.target.value)}
                          className="w-full rounded-xl bg-white/10 border border-white/10 px-3 py-2 outline-none focus:ring-2 focus:ring-cyan-400/50" />
                        <select value={currency} onChange={(e) => setCurrency(e.target.value)}
                          className="rounded-xl bg-white/10 border border-white/10 px-3 py-2 outline-none focus:ring-2 focus:ring-cyan-400/50">
                          <option value="TRY">TRY ₺</option>
                          <option value="USD">USD $</option>
                          <option value="EUR">EUR €</option>
                          <option value="GBP">GBP £</option>
                        </select>
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm text-slate-300 mb-1" htmlFor="years">Sözleşme Süresi (yıl)</label>
                      <input id="years" type="number" min="1" step="1" value={years}
                        onChange={(e) => setYears(parseInt(e.target.value || "1", 10))}
                        className="w-full rounded-xl bg-white/10 border border-white/10 px-3 py-2 outline-none focus:ring-2 focus:ring-cyan-400/50" />
                      <p className="text-xs text-slate-400 mt-1">Tam yıl kullanın (1, 2, 3, …). Bitiş = satış tarihi + yıl.</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm text-slate-300 mb-1" htmlFor="saleDate">Satış Tarihi</label>
                        <input id="saleDate" type="date" value={saleDate} onChange={(e) => setSaleDate(e.target.value)}
                          className="w-full rounded-xl bg-white/10 border border-white/10 px-3 py-2 outline-none focus:ring-2 focus:ring-cyan-400/50" />
                      </div>
                      <div>
                        <label className="block text-sm text-slate-300 mb-1" htmlFor="asOfDate">Hesaplama Tarihi</label>
                        <input id="asOfDate" type="date" value={asOfDate} onChange={(e) => setAsOfDate(e.target.value)}
                          className="w-full rounded-xl bg-white/10 border border-white/10 px-3 py-2 outline-none focus:ring-2 focus:ring-cyan-400/50" />
                      </div>
                    </div>

                    <div className="text-xs text-slate-400 leading-relaxed">
                      <ul className="list-disc pl-5 space-y-1">
                        <li>Kalan = tutar − (günlük oran × geçen gün).</li>
                        <li>Hesaplama tarihi satıştan önceyse geçen gün = 0; bitişten sonraysa kalan = 0.</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </section>

              <section className="lg:col-span-2">
                <div className="backdrop-blur-xl bg-white/5 border border-white/10 rounded-2xl p-5 shadow-2xl shadow-black/30">
                  <h2 className="text-lg font-medium mb-4">Sonuçlar</h2>

                  {!result ? (
                    <div className="text-slate-400">Sonuçları görmek için tüm alanları doldurun.</div>
                  ) : (
                    <div className="space-y-6">
                      <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                        <KPI label="Sözleşme Tutarı" value={fmt.format(result.amountNum)} />
                        <KPI label="Kalan Tutar" value={fmt.format(Math.round(result.remaining))} highlight />
                        <KPI label="Bugüne Kadar Gelirleşen" value={fmt.format(Math.round(result.recognized))} />
                        <KPI label="Günlük Oran" value={fmt.format(Math.round(result.dailyRate))} />
                      </div>

                      <div>
                        <div className="flex items-end justify-between mb-2">
                          <span className="text-sm text-slate-300">İlerleme</span>
                          <span className="text-xs text-slate-400">
                            {fmtNum.format(result.elapsed)} / {fmtNum.format(result.totalDays)} gün (%{pct(result.elapsed, result.totalDays).toFixed(1)})
                          </span>
                        </div>
                        <div className="h-3 w-full rounded-full bg-white/10 overflow-hidden">
                          <div className="h-3 bg-cyan-400/90" style={{ width: pct(result.elapsed, result.totalDays) + "%" }} />
                        </div>
                        <div className="flex items-center justify-between text-xs text-slate-400 mt-2">
                          <span>{result.sale.toISOString().slice(0,10)}</span>
                          <span>Bitiş: {result.endDate.toISOString().slice(0,10)}</span>
                        </div>
                      </div>

                      <div className="overflow-hidden rounded-xl border border-white/10">
                        <table className="w-full text-sm">
                          <tbody>
                            <Row k="Satış Tarihi" v={result.sale.toISOString().slice(0,10)} />
                            <Row k="Hesaplama Tarihi" v={result.asof.toISOString().slice(0,10)} />
                            <Row k="Sözleşme Bitişi" v={result.endDate.toISOString().slice(0,10)} />
                            <Row k="Toplam Gün" v={fmtNum.format(result.totalDays)} />
                            <Row k="Geçen Gün" v={fmtNum.format(result.elapsed)} />
                            <Row k="Kalan Gün" v={fmtNum.format(result.remainingDays)} />
                            <Row k="Gelirleşen Tutar" v={fmt.format(Math.round(result.recognized))} />
                            <Row k="Kalan Tutar" v={fmt.format(Math.round(result.remaining))} />
                          </tbody>
                        </table>
                      </div>

                      <ExampleHelper onFill={(a, y, daysElapsed) => {
                        const sale = new Date();
                        sale.setUTCDate(sale.getUTCDate() - daysElapsed);
                        const iso = sale.toISOString().slice(0,10);
                        const today = new Date().toISOString().slice(0,10);
                        setSaleDate(iso);
                        setYears(y);
                        setAmount(String(a));
                        setAsOfDate(today);
                      }} />
                    </div>
                  )}
                </div>
              </section>
            </main>

            <footer className="px-6 pb-12 text-xs text-slate-400">
              Doğrusal günlük paylaştırma. Artık yıllar (leap year) gün hesabıyla otomatik ele alınır.
            </footer>
          </div>
        );
      }

      function KPI({ label, value, highlight=false }) {
        return (
          <div className={`rounded-2xl p-4 border border-white/10 ${highlight ? "bg-cyan-500/10" : "bg-white/5"}`}>
            <div className="text-xs text-slate-400">{label}</div>
            <div className="text-xl md:text-2xl font-semibold mt-1 tracking-tight">{value}</div>
          </div>
        );
      }

      function Row({ k, v }) {
        return (
          <tr className="odd:bg-white/0 even:bg-white/5">
            <td className="px-4 py-3 text-slate-300 w-1/3">{k}</td>
            <td className="px-4 py-3 text-slate-100">{v}</td>
          </tr>
        );
      }

      function ExampleHelper({ onFill }) {
        return (
          <div className="mt-2 flex flex-wrap items-center gap-2 text-xs">
            <span className="text-slate-400 mr-1">Hızlı örnekler:</span>
            <button onClick={() => onFill(365000, 1, 150)}
              className="rounded-lg px-3 py-1.5 bg-white/10 hover:bg-white/20 border border-white/10"
              title="365.000 — 1 yıl — 150 gün (beklenen kalan 215.000)">
              365k · 1y · 150g
            </button>
            <button onClick={() => onFill(1200000, 2, 365)}
              className="rounded-lg px-3 py-1.5 bg-white/10 hover:bg-white/20 border border-white/10"
              title="1.200.000 — 2 yıl — 365 gün">
              1.2M · 2y · 365g
            </button>
            <button onClick={() => onFill(99999, 3, 800)}
              className="rounded-lg px-3 py-1.5 bg-white/10 hover:bg-white/20 border border-white/10"
              title="99.999 — 3 yıl — 800 gün">
              99,999 · 3y · 800g
            </button>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
