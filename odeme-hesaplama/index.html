<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>√ñdeme Hesaplama</title>
    <meta name="color-scheme" content="light dark" />

    <!-- Tailwind (must set darkMode:'class' BEFORE loading CDN) -->
    <script>
      window.tailwind = { config: { darkMode: "class" } };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/tr.js"></script>

    <style>
      /* --- Flatpickr dark-mode fixes --- */
      .dark .flatpickr-calendar {
        background: #0b1220;
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: #e5e7eb;
      }
      .dark .flatpickr-months,
      .dark .flatpickr-weekdays { background: transparent; }
      .dark .flatpickr-current-month,
      .dark .flatpickr-weekday,
      .dark .flatpickr-day { color: #e5e7eb; }
      .dark .flatpickr-day.disabled,
      .dark .flatpickr-day.prevMonthDay,
      .dark .flatpickr-day.nextMonthDay { color: #64748b; }
      .dark .flatpickr-day:hover { background: rgba(34, 211, 238, 0.15); }
      .dark .flatpickr-day.inRange {
        background: rgba(34, 211, 238, 0.08);
        border-color: transparent;
        color: #e5e7eb;
      }
      .dark .flatpickr-day.selected,
      .dark .flatpickr-day.startRange,
      .dark .flatpickr-day.endRange,
      .dark .flatpickr-day.selected:hover {
        background: rgba(34, 211, 238, 0.9);
        color: #0b1220;
      }
      .dark .flatpickr-monthDropdown-months,
      .dark .numInputWrapper input { color: #e5e7eb; }

      /* FIX: Calendar navigation arrows */
      .dark .flatpickr-prev-month,
      .dark .flatpickr-next-month {
        fill: #e5e7eb !important;
      }
      .dark .flatpickr-prev-month svg,
      .dark .flatpickr-next-month svg {
        fill: #e5e7eb !important;
        stroke: none;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useMemo, useEffect, useRef } = React;

      function useFlatpickr(initialISO, onChangeISO) {
        const ref = useRef(null);
        useEffect(() => {
          if (!ref.current) return;
          const fp = flatpickr(ref.current, {
            dateFormat: "d/m/Y",         // shows dd/mm/yyyy to user
            defaultDate: initialISO,     // initialize
            locale: flatpickr.l10ns.tr,
            onChange: (dates) => {
              if (dates.length) onChangeISO(dates[0].toISOString().slice(0,10));
            },
          });
          return () => fp.destroy();
        }, []);
        return ref;
      }

      function App() {
        // Theme with persistence; Tailwind uses .dark class
        const prefersDark = typeof window !== "undefined"
          && window.matchMedia?.("(prefers-color-scheme: dark)").matches;
        const [theme, setTheme] = useState(() =>
          localStorage.getItem("odeme-theme") || (prefersDark ? "dark" : "light")
        );
        useEffect(() => {
          localStorage.setItem("odeme-theme", theme);
          document.documentElement.classList.toggle("dark", theme === "dark");
        }, [theme]);
        const isDark = theme === "dark";

        // Data
        const todayISO = new Date().toISOString().slice(0,10);
        const [amount, setAmount] = useState("");
        const [years, setYears]   = useState("1");
        const [saleDate, setSaleDate]   = useState(todayISO);
        const [asOfDate, setAsOfDate]   = useState(todayISO);

        // Calendar refs (consistent popup on all browsers)
        const saleRef = useFlatpickr(saleDate, setSaleDate);
        const asOfRef = useFlatpickr(asOfDate, setAsOfDate);

        // Helpers
        function parseISO(d){ const [y,m,day]=d.split("-").map(Number); return new Date(Date.UTC(y,(m||1)-1,day||1));}
        function addYears(date,y){ const d=new Date(date.getTime()); d.setUTCFullYear(d.getUTCFullYear()+y); return d;}
        function diffDays(a,b){
          const MS=86400000;
          const A=Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate());
          const B=Date.UTC(b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate());
          return Math.floor((B-A)/MS);
        }
        function formatDate(date){
          const d=String(date.getUTCDate()).padStart(2,"0");
          const m=String(date.getUTCMonth()+1).padStart(2,"0");
          const y=date.getUTCFullYear();
          return `${d}/${m}/${y}`;
        }
        const fmt    = new Intl.NumberFormat("tr-TR",{style:"currency",currency:"TRY",maximumFractionDigits:0});
        const fmtNum = new Intl.NumberFormat("tr-TR",{maximumFractionDigits:0});
        const pct = (n,d)=> d<=0?0:Math.min(100,Math.max(0,(n/d)*100));

        const result = useMemo(() => {
          const amountNum = Number((amount||"").toString().replace(/[^0-9.,-]/g,"").replace(/,/g,"."));
          if (!saleDate || !asOfDate || !amountNum || amountNum < 0) return null;

          const sale = parseISO(saleDate);
          const asof = parseISO(asOfDate);
          let yearsNum = parseInt(years||"1",10);
          if (isNaN(yearsNum) || yearsNum < 1) yearsNum = 1;

          const end = addYears(sale, yearsNum);
          const totalDays = Math.max(0, diffDays(sale, end));
          const elapsedRaw = diffDays(sale, asof);
          const elapsed = Math.min(Math.max(0, elapsedRaw), totalDays);
          const remainingDays = Math.max(0, totalDays - elapsed);

          const dailyRate = totalDays>0 ? amountNum/totalDays : 0;
          const recognized = dailyRate * elapsed;
          const remaining = Math.max(0, amountNum - recognized);

          return { totalDays, elapsed, remainingDays, dailyRate, recognized, remaining, endDate:end, sale, asof, amountNum };
        }, [amount, years, saleDate, asOfDate]);

        return (
          <div className={
            "min-h-screen w-full transition-colors " +
            (isDark
              ? "bg-gradient-to-br from-slate-950 via-slate-900 to-slate-800 text-slate-100"
              : "bg-gradient-to-br from-slate-200 via-slate-100 to-slate-50 text-slate-900")
          }>
            <header className="px-6 pt-8 pb-4 flex items-start justify-between gap-4">
              <div>
                <h1 className="text-3xl md:text-4xl font-semibold tracking-tight">√ñdeme Hesaplama</h1>
              </div>
              <button
                onClick={() => setTheme(isDark ? "light" : "dark")}
                className={
                  "select-none rounded-xl px-3 py-2 text-sm font-medium border transition " +
                  (isDark
                    ? "bg-white/10 border-white/10 hover:bg-white/20 text-slate-100"
                    : "bg-slate-50/90 border-slate-300 hover:bg-slate-100 text-slate-900 shadow-sm")
                }
                title={isDark ? "A√ßƒ±k tema" : "Koyu tema"}
              >
                {isDark ? "‚òÄÔ∏è A√ßƒ±k" : "üåô Koyu"}
              </button>
            </header>

            <main className="px-6 pb-12 grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
              {/* Inputs */}
              <section className="lg:col-span-1">
                <div className={
                  "rounded-2xl p-5 border shadow-2xl transition " +
                  (isDark
                    ? "backdrop-blur-xl bg-white/5 border-white/10 shadow-black/30"
                    : "bg-slate-50/90 border-slate-300 shadow-sm")
                }>
                  <h2 className="text-lg font-medium mb-4">Girdiler</h2>
                  <div className="space-y-4">
                    <div>
                      <label className={"block text-sm mb-1 " + (isDark ? "text-slate-300" : "text-slate-700")} htmlFor="amount">Satƒ±≈ü Tutarƒ±</label>
                      <input id="amount" type="number" min="0" inputMode="decimal" placeholder="√∂rn. 365000"
                        value={amount} onChange={(e) => setAmount(e.target.value)}
                        className={
                          "w-full rounded-xl px-3 py-2 outline-none focus:ring-2 transition " +
                          (isDark
                            ? "bg-white/10 border border-white/10 focus:ring-cyan-400/50"
                            : "bg-slate-50 border border-slate-300 focus:ring-cyan-300")
                        } />
                    </div>

                    <div>
                      <label className={"block text-sm mb-1 " + (isDark ? "text-slate-300" : "text-slate-700")} htmlFor="years">S√∂zle≈üme S√ºresi (yƒ±l)</label>
                      <input id="years" type="number" min="1" step="1" value={years}
                        onChange={(e) => setYears(e.target.value)}
                        className={
                          "w-full rounded-xl px-3 py-2 outline-none focus:ring-2 transition " +
                          (isDark
                            ? "bg-white/10 border border-white/10 focus:ring-cyan-400/50"
                            : "bg-slate-50 border border-slate-300 focus:ring-cyan-300")
                        } />
                      <p className={"text-xs mt-1 " + (isDark ? "text-slate-400" : "text-slate-500")}>
                        Tam yƒ±l kullanƒ±n (1, 2, 3, ‚Ä¶). Biti≈ü = satƒ±≈ü tarihi + yƒ±l.
                      </p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className={"block text-sm mb-1 " + (isDark ? "text-slate-300" : "text-slate-700")} htmlFor="saleDate">Satƒ±≈ü Tarihi</label>
                        <input ref={saleRef} id="saleDate"
                          className={
                            "w-full rounded-xl px-3 py-2 outline-none focus:ring-2 transition cursor-pointer " +
                            (isDark
                              ? "bg-white/10 border border-white/10 focus:ring-cyan-400/50"
                              : "bg-slate-50 border border-slate-300 focus:ring-cyan-300")
                          } />
                      </div>
                      <div>
                        <label className={"block text-sm mb-1 " + (isDark ? "text-slate-300" : "text-slate-700")} htmlFor="asOfDate">Hesaplama Tarihi</label>
                        <input ref={asOfRef} id="asOfDate"
                          className={
                            "w-full rounded-xl px-3 py-2 outline-none focus:ring-2 transition cursor-pointer " +
                            (isDark
                              ? "bg-white/10 border border-white/10 focus:ring-cyan-400/50"
                              : "bg-slate-50 border border-slate-300 focus:ring-cyan-300")
                          } />
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              {/* Results */}
              <section className="lg:col-span-2">
                <div className={
                  "rounded-2xl p-5 border shadow-2xl transition " +
                  (isDark
                    ? "backdrop-blur-xl bg-white/5 border-white/10 shadow-black/30"
                    : "bg-slate-50/90 border-slate-300 shadow-sm")
                }>
                  <h2 className="text-lg font-medium mb-4">Sonu√ßlar</h2>

                  {!result ? (
                    <div className={isDark ? "text-slate-400" : "text-slate-600"}>Sonu√ßlarƒ± g√∂rmek i√ßin t√ºm alanlarƒ± doldurun.</div>
                  ) : (
                    <div className="space-y-6">
                      <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                        <KPI label="S√∂zle≈üme Tutarƒ±" value={fmt.format(result.amountNum)} isDark={isDark} />
                        <KPI label="Kalan Tutar" value={fmt.format(Math.round(result.remaining))} highlight isDark={isDark} />
                        <KPI label="Bug√ºne Kadar Gelirle≈üen" value={fmt.format(Math.round(result.recognized))} isDark={isDark} />
                        <KPI label="G√ºnl√ºk Oran" value={fmt.format(Math.round(result.dailyRate))} isDark={isDark} />
                      </div>

                      <div>
                        <div className="flex items-end justify-between mb-2">
                          <span className={"text-sm " + (isDark ? "text-slate-300" : "text-slate-700")}>ƒ∞lerleme</span>
                          <span className={"text-xs " + (isDark ? "text-slate-400" : "text-slate-600")}>
                            {fmtNum.format(result.elapsed)} / {fmtNum.format(result.totalDays)} g√ºn (%{pct(result.elapsed, result.totalDays).toFixed(1)})
                          </span>
                        </div>
                        <div className={"h-3 w-full rounded-full overflow-hidden " + (isDark ? "bg-white/10" : "bg-slate-300/60")}>
                          <div className="h-3" style={{ backgroundColor: "rgb(34 211 238 / 0.9)", width: pct(result.elapsed, result.totalDays) + "%" }} />
                        </div>
                        <div className={"flex items-center justify-between text-xs mt-2 " + (isDark ? "text-slate-400" : "text-slate-600")}>\n                          <span>{formatDate(result.sale)}</span>
                          <span>Biti≈ü: {formatDate(result.endDate)}</span>
                        </div>
                      </div>

                      <div className={"overflow-hidden rounded-xl border " + (isDark ? "border-white/10" : "border-slate-300")}>
                        <table className="w-full text-sm">
                          <tbody>
                            <Row k="Satƒ±≈ü Tarihi"      v={formatDate(result.sale)}     isDark={isDark} />
                            <Row k="Hesaplama Tarihi"  v={formatDate(result.asof)}     isDark={isDark} />
                            <Row k="S√∂zle≈üme Biti≈üi"   v={formatDate(result.endDate)}  isDark={isDark} />
                            <Row k="Toplam G√ºn"        v={fmtNum.format(result.totalDays)}      isDark={isDark} />
                            <Row k="Ge√ßen G√ºn"         v={fmtNum.format(result.elapsed)}        isDark={isDark} />
                            <Row k="Kalan G√ºn"         v={fmtNum.format(result.remainingDays)}  isDark={isDark} />
                            <Row k="Gelirle≈üen Tutar"  v={fmt.format(Math.round(result.recognized))} isDark={isDark} />
                            <Row k="Kalan Tutar"       v={fmt.format(Math.round(result.remaining))}  isDark={isDark} />
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}
                </div>
              </section>
            </main>
          </div>
        );
      }

      function KPI({ label, value, highlight=false, isDark }) {
        return (
          <div className={
            "rounded-2xl p-4 border transition " +
            (highlight
              ? (isDark ? "bg-cyan-500/10 border-white/10" : "bg-cyan-50 border-cyan-200")
              : (isDark ? "bg-white/5 border-white/10"     : "bg-slate-50/90 border-slate-300 shadow-sm"))
          }>
            <div className={"text-xs " + (isDark ? "text-slate-400" : "text-slate-600")}>{label}</div>
            <div className="text-xl md:text-2xl font-semibold mt-1 tracking-tight">{value}</div>
          </div>
        );
      }

      function Row({ k, v, isDark }) {
        return (
          <tr className={isDark ? "odd:bg-white/0 even:bg-white/5" : "odd:bg-slate-50 even:bg-slate-100"}>
            <td className={"px-4 py-3 w-1/3 " + (isDark ? "text-slate-300" : "text-slate-700")}>{k}</td>
            <td className={"px-4 py-3 " + (isDark ? "text-slate-100" : "text-slate-900")}>{v}</td>
          </tr>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
