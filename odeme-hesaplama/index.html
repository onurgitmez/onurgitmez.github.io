<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title> Geri Ödeme Hesaplama</title>
    <meta name="color-scheme" content="light dark">

    <!-- Tailwind (runtime) -->
    <script>
      // Enable class-based dark mode switching
      window.tailwind = { config: { darkMode: "class" } };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 + ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for in-page JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      const { useMemo, useState, useEffect } = React;

      function App() {
        // THEME: prefers-color-scheme with persistence
        const prefersDark = typeof window !== "undefined"
          && window.matchMedia
          && window.matchMedia("(prefers-color-scheme: dark)").matches;

        const [theme, setTheme] = useState(() => {
          const saved = typeof window !== "undefined" ? localStorage.getItem("odeme-theme") : null;
          return saved || (prefersDark ? "dark" : "light");
        });

        useEffect(() => {
          try { localStorage.setItem("odeme-theme", theme); } catch {}
          // Reflect theme as a class on <html> for Tailwind "dark"
          const root = document.documentElement;
          if (theme === "dark") root.classList.add("dark");
          else root.classList.remove("dark");
        }, [theme]);

        const isDark = theme === "dark";
        const t = (darkCls, lightCls) => (isDark ? darkCls : lightCls);

        // DATA
        const todayISO = new Date().toISOString().slice(0, 10);
        const [amount, setAmount] = useState("");
        const [years, setYears] = useState("1");  // store raw string for easier typing
        const [saleDate, setSaleDate] = useState(todayISO);
        const [asOfDate, setAsOfDate] = useState(() => new Date().toISOString().slice(0, 10));

        function parseISO(d) {
          const [y,m,day] = d.split("-").map(Number);
          return new Date(Date.UTC(y, (m||1)-1, day||1));
        }
        function addYears(date, y) {
          const d = new Date(date.getTime());
          d.setUTCFullYear(d.getUTCFullYear() + y);
          return d;
        }
        function diffDays(start, end) {
          const MS = 24*60*60*1000;
          const a = Date.UTC(start.getUTCFullYear(), start.getUTCMonth(), start.getUTCDate());
          const b = Date.UTC(end.getUTCFullYear(),   end.getUTCMonth(),   end.getUTCDate());
          return Math.floor((b - a) / MS);
        }
        function formatDate(date) {
          const d = date.getUTCDate().toString().padStart(2,"0");
          const m = (date.getUTCMonth()+1).toString().padStart(2,"0");
          const y = date.getUTCFullYear();
          return `${d}/${m}/${y}`;
        }

        const result = useMemo(() => {
          const amountNum = Number((amount || "").toString().replace(/[^0-9.,-]/g, "").replace(/,/g, "."));
          if (!saleDate || !asOfDate || !amountNum || amountNum < 0) return null;

          const sale = parseISO(saleDate);
          const asof = parseISO(asOfDate);

          let yearsNum = parseInt(years || "1", 10);
          if (isNaN(yearsNum) || yearsNum < 1) yearsNum = 1;

          const end  = addYears(sale, yearsNum);
          const totalDays = Math.max(0, diffDays(sale, end));
          const elapsedRaw = diffDays(sale, asof);
          const elapsed = Math.min(Math.max(0, elapsedRaw), totalDays);
          const remainingDays = Math.max(0, totalDays - elapsed);

          const dailyRate = totalDays > 0 ? amountNum / totalDays : 0;
          const recognized = dailyRate * elapsed;
          const remaining = Math.max(0, amountNum - recognized);

          return { totalDays, elapsed, remainingDays, dailyRate, recognized, remaining, endDate: end, sale, asof, amountNum };
        }, [amount, years, saleDate, asOfDate]);

        const fmt = new Intl.NumberFormat("tr-TR", { style: "currency", currency: "TRY", maximumFractionDigits: 0 });
        const fmtNum = new Intl.NumberFormat("tr-TR", { maximumFractionDigits: 0 });
        const pct = (n, d) => (d <= 0 ? 0 : Math.min(100, Math.max(0, (n / d) * 100)));

        return (
          <div className={
            "min-h-screen w-full transition-colors " +
            t(
              "bg-gradient-to-br from-slate-950 via-slate-900 to-slate-800 text-slate-100",
              "bg-gradient-to-br from-slate-200 via-slate-100 to-slate-50 text-slate-900"
            )
          }>
            <header className="px-6 pt-8 pb-4 flex items-start justify-between gap-4">
              <div>
                <h1 className="text-3xl md:text-4xl font-semibold tracking-tight"> Geri Ödeme Hesaplama</h1>
                <p className={ "mt-2 text-sm " + t("text-slate-400","text-slate-600") }>
                  Ay hediyeleri veya ekstra satılan entegrasyonları hesaplamaya dahil etmeyin.
                </p>
              </div>

              {/* Theme toggle */}
              <button
                onClick={() => setTheme(isDark ? "light" : "dark")}
                className={
                  "select-none rounded-xl px-3 py-2 text-sm font-medium border transition " +
                  t("bg-white/10 border-white/10 hover:bg-white/20 text-slate-100",
                    "bg-slate-50/90 border-slate-300 hover:bg-slate-100 text-slate-900 shadow-sm")
                }
                title={isDark ? "Açık tema" : "Koyu tema"}
              >
                {isDark ? "☀️ Açık" : "🌙 Koyu"}
              </button>
            </header>

            <main className="px-6 pb-12 grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
              {/* Inputs */}
              <section className="lg:col-span-1">
                <div className={
                  "rounded-2xl p-5 border shadow-2xl transition " +
                  t("backdrop-blur-xl bg-white/5 border-white/10 shadow-black/30",
                    "bg-slate-50/90 border-slate-300 shadow-sm")
                }>
                  <h2 className="text-lg font-medium mb-4">Girdiler</h2>

                  <div className="space-y-4">
                    <div>
                      <label className={"block text-sm mb-1 " + t("text-slate-300","text-slate-700")} htmlFor="amount">Satış Tutarı</label>
                      <input
                        id="amount"
                        type="number"
                        min="0"
                        inputMode="decimal"
                        placeholder="örn. 365000"
                        value={amount}
                        onChange={(e) => setAmount(e.target.value)}
                        className={
                          "w-full rounded-xl px-3 py-2 outline-none focus:ring-2 transition " +
                          t("bg-white/10 border border-white/10 focus:ring-cyan-400/50",
                            "bg-slate-50 border border-slate-300 focus:ring-cyan-300")
                        }
                      />
                    </div>

                    <div>
                      <label className={"block text-sm mb-1 " + t("text-slate-300","text-slate-700")} htmlFor="years">Sözleşme Süresi (yıl)</label>
                      <input
                        id="years"
                        type="number"
                        min="1"
                        step="1"
                        value={years}
                        onChange={(e) => setYears(e.target.value)}
                        className={
                          "w-full rounded-xl px-3 py-2 outline-none focus:ring-2 transition " +
                          t("bg-white/10 border border-white/10 focus:ring-cyan-400/50",
                            "bg-slate-50 border border-slate-300 focus:ring-cyan-300")
                        }
                      />
                      <p className={"text-xs mt-1 " + t("text-slate-400","text-slate-500")}>
                        Tam yıl kullanın (1, 2, 3, …). Bitiş = satış tarihi + yıl.
                      </p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className={"block text-sm mb-1 " + t("text-slate-300","text-slate-700")} htmlFor="saleDate">Satış Tarihi</label>
                        <input
                          id="saleDate"
                          type="date"
                          value={saleDate}
                          onChange={(e) => setSaleDate(e.target.value)}
                          className={
                            "w-full rounded-xl px-3 py-2 outline-none focus:ring-2 transition " +
                            t("bg-white/10 border border-white/10 focus:ring-cyan-400/50",
                              "bg-slate-50 border border-slate-300 focus:ring-cyan-300")
                          }
                        />
                      </div>
                      <div>
                        <label className={"block text-sm mb-1 " + t("text-slate-300","text-slate-700")} htmlFor="asOfDate">Hesaplama Tarihi</label>
                        <input
                          id="asOfDate"
                          type="date"
                          value={asOfDate}
                          onChange={(e) => setAsOfDate(e.target.value)}
                          className={
                            "w-full rounded-xl px-3 py-2 outline-none focus:ring-2 transition " +
                            t("bg-white/10 border border-white/10 focus:ring-cyan-400/50",
                              "bg-slate-50 border border-slate-300 focus:ring-cyan-300")
                          }
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              {/* Results */}
              <section className="lg:col-span-2">
                <div className={
                  "rounded-2xl p-5 border shadow-2xl transition " +
                  t("backdrop-blur-xl bg-white/5 border-white/10 shadow-black/30",
                    "bg-slate-50/90 border-slate-300 shadow-sm")
                }>
                  <h2 className="text-lg font-medium mb-4">Sonuçlar</h2>

                  {!result ? (
                    <div className={ t("text-slate-400","text-slate-600") }>Sonuçları görmek için tüm alanları doldurun.</div>
                  ) : (
                    <div className="space-y-6">
                      <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                        <KPI label="Sözleşme Tutarı" value={fmt.format(result.amountNum)} isDark={isDark} />
                        <KPI label="Kalan Tutar" value={fmt.format(Math.round(result.remaining))} highlight isDark={isDark} />
                        <KPI label="Bugüne Kadar Gelirleşen" value={fmt.format(Math.round(result.recognized))} isDark={isDark} />
                        <KPI label="Günlük Oran" value={fmt.format(Math.round(result.dailyRate))} isDark={isDark} />
                      </div>

                      <div>
                        <div className="flex items-end justify-between mb-2">
                          <span className={ "text-sm " + t("text-slate-300","text-slate-700") }>İlerleme</span>
                          <span className={ "text-xs " + t("text-slate-400","text-slate-600") }>
                            {fmtNum.format(result.elapsed)} / {fmtNum.format(result.totalDays)} gün (%{pct(result.elapsed, result.totalDays).toFixed(1)})
                          </span>
                        </div>
                        <div className={ "h-3 w-full rounded-full overflow-hidden " + t("bg-white/10","bg-slate-300/60") }>
                          <div className="h-3" style={{ backgroundColor: "rgb(34 211 238 / 0.9)", width: pct(result.elapsed, result.totalDays) + "%" }} />
                        </div>
                        <div className={ "flex items-center justify-between text-xs mt-2 " + t("text-slate-400","text-slate-600") }>
                          <span>{formatDate(result.sale)}</span>
                          <span>Bitiş: {formatDate(result.endDate)}</span>
                        </div>
                      </div>

                      <div className={ "overflow-hidden rounded-xl border " + t("border-white/10","border-slate-300") }>
                        <table className="w-full text-sm">
                          <tbody>
                            <Row k="Satış Tarihi" v={formatDate(result.sale)} isDark={isDark} />
                            <Row k="Hesaplama Tarihi" v={formatDate(result.asof)} isDark={isDark} />
                            <Row k="Sözleşme Bitişi" v={formatDate(result.endDate)} isDark={isDark} />
                            <Row k="Toplam Gün" v={fmtNum.format(result.totalDays)} isDark={isDark} />
                            <Row k="Geçen Gün" v={fmtNum.format(result.elapsed)} isDark={isDark} />
                            <Row k="Kalan Gün" v={fmtNum.format(result.remainingDays)} isDark={isDark} />
                            <Row k="Gelirleşen Tutar" v={fmt.format(Math.round(result.recognized))} isDark={isDark} />
                            <Row k="Kalan Tutar" v={fmt.format(Math.round(result.remaining))} isDark={isDark} />
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}
                </div>
              </section>
            </main>
          </div>
        );
      }

      function KPI({ label, value, highlight=false, isDark }) {
        return (
          <div className={
            "rounded-2xl p-4 border transition " +
            (highlight
              ? (isDark ? "bg-cyan-500/10 border-white/10" : "bg-cyan-50 border-cyan-200")
              : (isDark ? "bg-white/5 border-white/10"     : "bg-slate-50/90 border-slate-300 shadow-sm"))
          }>
            <div className={ "text-xs " + (isDark ? "text-slate-400" : "text-slate-600") }>{label}</div>
            <div className="text-xl md:text-2xl font-semibold mt-1 tracking-tight">{value}</div>
          </div>
        );
      }

      function Row({ k, v, isDark }) {
        return (
          <tr className={ isDark ? "odd:bg-white/0 even:bg-white/5" : "odd:bg-slate-50 even:bg-slate-100" }>
            <td className={ "px-4 py-3 w-1/3 " + (isDark ? "text-slate-300" : "text-slate-700") }>{k}</td>
            <td className={ "px-4 py-3 " + (isDark ? "text-slate-100" : "text-slate-900") }>{v}</td>
          </tr>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
