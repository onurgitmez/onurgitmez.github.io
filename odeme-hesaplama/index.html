<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>√ñdeme Hesaplama</title>
    <meta name="color-scheme" content="dark light" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/tr.js"></script>

    <style>
      /* --- Flatpickr dark-mode fixes --- */
      .dark .flatpickr-calendar {
        background: #0b1220;
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: #e5e7eb;
      }
      .dark .flatpickr-months,
      .dark .flatpickr-weekdays {
        background: transparent;
      }
      .dark .flatpickr-current-month,
      .dark .flatpickr-weekday,
      .dark .flatpickr-day {
        color: #e5e7eb;
      }
      .dark .flatpickr-day.disabled,
      .dark .flatpickr-day.prevMonthDay,
      .dark .flatpickr-day.nextMonthDay {
        color: #64748b;
      }
      .dark .flatpickr-day:hover {
        background: rgba(34, 211, 238, 0.15);
      }
      .dark .flatpickr-day.inRange {
        background: rgba(34, 211, 238, 0.08);
        border-color: transparent;
        color: #e5e7eb;
      }
      .dark .flatpickr-day.selected,
      .dark .flatpickr-day.startRange,
      .dark .flatpickr-day.endRange,
      .dark .flatpickr-day.selected:hover {
        background: rgba(34, 211, 238, 0.9);
        color: #0b1220;
      }
      .dark .flatpickr-monthDropdown-months,
      .dark .numInputWrapper input {
        color: #e5e7eb;
      }
      .dark .flatpickr-next-month svg,
      .dark .flatpickr-prev-month svg {
        fill: #e5e7eb;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useMemo, useEffect, useRef } = React;

      // Custom hook to bind flatpickr to an input
      function useFlatpickr(initialDate, onChange) {
        const inputRef = useRef(null);
        useEffect(() => {
          if (inputRef.current) {
            const fp = flatpickr(inputRef.current, {
              dateFormat: "d/m/Y",
              defaultDate: initialDate,
              locale: flatpickr.l10ns.tr,
              onChange: (dates) => {
                if (dates.length > 0) {
                  const iso = dates[0].toISOString().slice(0, 10);
                  onChange(iso);
                }
              },
            });
            return () => fp.destroy();
          }
        }, []);
        return inputRef;
      }

      function App() {
        const todayISO = new Date().toISOString().slice(0, 10);

        const [amount, setAmount] = useState("");
        const [years, setYears] = useState("1");
        const [saleDate, setSaleDate] = useState(todayISO);
        const [asOfDate, setAsOfDate] = useState(todayISO);
        const [theme, setTheme] = useState(() => {
          if (typeof window !== "undefined") {
            return (
              localStorage.getItem("theme") ||
              (window.matchMedia("(prefers-color-scheme: dark)").matches
                ? "dark"
                : "light")
            );
          }
          return "dark";
        });

        useEffect(() => {
          localStorage.setItem("theme", theme);
          document.documentElement.classList.toggle("dark", theme === "dark");
        }, [theme]);

        const saleRef = useFlatpickr(saleDate, setSaleDate);
        const asOfRef = useFlatpickr(asOfDate, setAsOfDate);

        function parseISO(d) {
          const [y, m, day] = d.split("-").map(Number);
          return new Date(Date.UTC(y, (m || 1) - 1, day || 1));
        }
        function addYears(date, y) {
          const d = new Date(date.getTime());
          d.setUTCFullYear(d.getUTCFullYear() + y);
          return d;
        }
        function diffDays(start, end) {
          const MS = 24 * 60 * 60 * 1000;
          const a = Date.UTC(
            start.getUTCFullYear(),
            start.getUTCMonth(),
            start.getUTCDate()
          );
          const b = Date.UTC(
            end.getUTCFullYear(),
            end.getUTCMonth(),
            end.getUTCDate()
          );
          return Math.floor((b - a) / MS);
        }

        const result = useMemo(() => {
          const amountNum = Number(
            (amount || "")
              .toString()
              .replace(/[^0-9.,-]/g, "")
              .replace(/,/g, ".")
          );
          if (!saleDate || !asOfDate || !amountNum || amountNum < 0)
            return null;

          const sale = parseISO(saleDate);
          const asof = parseISO(asOfDate);

          let yearsNum = parseInt(years || "1", 10);
          if (isNaN(yearsNum) || yearsNum < 1) yearsNum = 1;

          const end = addYears(sale, yearsNum);
          const totalDays = Math.max(0, diffDays(sale, end));
          const elapsedRaw = diffDays(sale, asof);
          const elapsed = Math.min(Math.max(0, elapsedRaw), totalDays);
          const remainingDays = Math.max(0, totalDays - elapsed);

          const dailyRate = totalDays > 0 ? amountNum / totalDays : 0;
          const recognized = dailyRate * elapsed;
          const remaining = Math.max(0, amountNum - recognized);

          return {
            totalDays,
            elapsed,
            remainingDays,
            dailyRate,
            recognized,
            remaining,
            endDate: end,
            sale,
            asof,
            amountNum,
          };
        }, [amount, years, saleDate, asOfDate]);

        const fmt = new Intl.NumberFormat("tr-TR", {
          style: "currency",
          currency: "TRY",
          maximumFractionDigits: 0,
        });

        const fmtNum = new Intl.NumberFormat("tr-TR", {
          maximumFractionDigits: 0,
        });

        function pct(n, d) {
          if (d <= 0) return 0;
          return Math.min(100, Math.max(0, (n / d) * 100));
        }

        const isDark = theme === "dark";

        return (
          <div
            className={
              "min-h-screen w-full transition-colors " +
              (isDark
                ? "bg-gradient-to-br from-slate-950 via-slate-900 to-slate-800 text-slate-100"
                : "bg-gradient-to-br from-slate-200 via-slate-100 to-slate-50 text-slate-900")
            }
          >
            <header className="px-6 pt-8 pb-4 flex items-center justify-between">
              <div>
                <h1 className="text-3xl md:text-4xl font-semibold tracking-tight">
                  √ñdeme Hesaplama
                </h1>
                <p className="text-slate-400 mt-2 text-sm">
                  Satƒ±≈ü tarihi, s√∂zle≈üme s√ºresi (yƒ±l) ve tutarƒ± girin; uygulama
                  g√ºn bazlƒ± (artƒ±k yƒ±llar d√¢hil) doƒürusal payla≈ütƒ±rma ile kalan
                  ve gelirle≈üen tutarlarƒ± hesaplar.
                </p>
              </div>
              <button
                onClick={() => setTheme(isDark ? "light" : "dark")}
                className="rounded-lg border px-3 py-1 text-sm"
              >
                {isDark ? "‚òÄÔ∏è A√ßƒ±k" : "üåô Koyu"}
              </button>
            </header>

            <main className="px-6 pb-12 grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
              <section className="lg:col-span-1">
                <div
                  className={
                    (isDark
                      ? "backdrop-blur-xl bg-white/5 border border-white/10"
                      : "backdrop-blur-xl bg-slate-50/90 border border-slate-300") +
                    " rounded-2xl p-5 shadow-xl"
                  }
                >
                  <h2 className="text-lg font-medium mb-4">Girdiler</h2>

                  <div className="space-y-4">
                    <div>
                      <label
                        className="block text-sm mb-1"
                        htmlFor="amount"
                      >
                        Satƒ±≈ü Tutarƒ±
                      </label>
                      <input
                        id="amount"
                        type="number"
                        min="0"
                        inputMode="decimal"
                        placeholder="√∂rn. 365000"
                        value={amount}
                        onChange={(e) => setAmount(e.target.value)}
                        className={
                          (isDark
                            ? "bg-white/10 border-white/10"
                            : "bg-slate-50 border-slate-300") +
                          " w-full rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-cyan-400/50"
                        }
                      />
                    </div>

                    <div>
                      <label
                        className="block text-sm mb-1"
                        htmlFor="years"
                      >
                        S√∂zle≈üme S√ºresi (yƒ±l)
                      </label>
                      <input
                        id="years"
                        type="number"
                        min="1"
                        step="1"
                        value={years}
                        onChange={(e) => setYears(e.target.value)}
                        className={
                          (isDark
                            ? "bg-white/10 border-white/10"
                            : "bg-slate-50 border-slate-300") +
                          " w-full rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-cyan-400/50"
                        }
                      />
                      <p className="text-xs text-slate-400 mt-1">
                        Tam yƒ±l kullanƒ±n (1, 2, 3, ‚Ä¶). Biti≈ü = satƒ±≈ü tarihi +
                        yƒ±l.
                      </p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label
                          className="block text-sm mb-1"
                          htmlFor="saleDate"
                        >
                          Satƒ±≈ü Tarihi
                        </label>
                        <input
                          ref={saleRef}
                          id="saleDate"
                          className={
                            (isDark
                              ? "bg-white/10 border-white/10"
                              : "bg-slate-50 border-slate-300") +
                            " w-full rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-cyan-400/50"
                          }
                        />
                      </div>
                      <div>
                        <label
                          className="block text-sm mb-1"
                          htmlFor="asOfDate"
                        >
                          Hesaplama Tarihi
                        </label>
                        <input
                          ref={asOfRef}
                          id="asOfDate"
                          className={
                            (isDark
                              ? "bg-white/10 border-white/10"
                              : "bg-slate-50 border-slate-300") +
                            " w-full rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-cyan-400/50"
                          }
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              <section className="lg:col-span-2">
                <div
                  className={
                    (isDark
                      ? "backdrop-blur-xl bg-white/5 border border-white/10"
                      : "backdrop-blur-xl bg-slate-50/90 border border-slate-300") +
                    " rounded-2xl p-5 shadow-xl"
                  }
                >
                  <h2 className="text-lg font-medium mb-4">Sonu√ßlar</h2>

                  {!result ? (
                    <div className="text-slate-400">
                      Sonu√ßlarƒ± g√∂rmek i√ßin t√ºm alanlarƒ± doldurun.
                    </div>
                  ) : (
                    <div className="space-y-6">
                      <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                        <KPI
                          label="S√∂zle≈üme Tutarƒ±"
                          value={fmt.format(result.amountNum)}
                        />
                        <KPI
                          label="Kalan Tutar"
                          value={fmt.format(Math.round(result.remaining))}
                          highlight
                        />
                        <KPI
                          label="Bug√ºne Kadar Ge√ßen"
                          value={fmt.format(Math.round(result.recognized))}
                        />
                        <KPI
                          label="G√ºnl√ºk Oran"
                          value={fmt.format(Math.round(result.dailyRate))}
                        />
                      </div>

                      <div>
                        <div className="flex items-end justify-between mb-2">
                          <span className="text-sm">ƒ∞lerleme</span>
                          <span className="text-xs text-slate-400">
                            {fmtNum.format(result.elapsed)} /{" "}
                            {fmtNum.format(result.totalDays)} g√ºn (%{pct(
                              result.elapsed,
                              result.totalDays
                            ).toFixed(1)})
                          </span>
                        </div>
                        <div className="h-3 w-full rounded-full bg-white/10 overflow-hidden">
                          <div
                            className="h-3 bg-cyan-400/90"
                            style={{
                              width:
                                pct(result.elapsed, result.totalDays) + "%",
                            }}
                          />
                        </div>
                        <div className="flex items-center justify-between text-xs text-slate-400 mt-2">
                          <span>{result.sale.toISOString().slice(0, 10)}</span>
                          <span>
                            Biti≈ü: {result.endDate.toISOString().slice(0, 10)}
                          </span>
                        </div>
                      </div>

                      <div
                        className={
                          (isDark ? "border-white/10" : "border-slate-300") +
                          " overflow-hidden rounded-xl border"
                        }
                      >
                        <table className="w-full text-sm">
                          <tbody>
                            <Row
                              k="Satƒ±≈ü Tarihi"
                              v={result.sale.toISOString().slice(0, 10)}
                            />
                            <Row
                              k="Hesaplama Tarihi"
                              v={result.asof.toISOString().slice(0, 10)}
                            />
                            <Row
                              k="S√∂zle≈üme Biti≈üi"
                              v={result.endDate.toISOString().slice(0, 10)}
                            />
                            <Row
                              k="Toplam G√ºn"
                              v={fmtNum.format(result.totalDays)}
                            />
                            <Row
                              k="Ge√ßen G√ºn"
                              v={fmtNum.format(result.elapsed)}
                            />
                            <Row
                              k="Kalan G√ºn"
                              v={fmtNum.format(result.remainingDays)}
                            />
                            <Row
                              k="Ge√ßen Tutar"
                              v={fmt.format(Math.round(result.recognized))}
                            />
                            <Row
                              k="Kalan Tutar"
                              v={fmt.format(Math.round(result.remaining))}
                            />
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}
                </div>
              </section>
            </main>
          </div>
        );
      }

      function KPI({ label, value, highlight = false }) {
        return (
          <div
            className={`rounded-2xl p-4 border ${
              highlight ? "bg-cyan-500/10 border-cyan-200" : "border-slate-300 bg-slate-50/60 dark:border-white/10 dark:bg-white/5"
            }`}
          >
            <div className="text-xs text-slate-400">{label}</div>
            <div className="text-xl md:text-2xl font-semibold mt-1 tracking-tight">
              {value}
            </div>
          </div>
        );
      }

      function Row({ k, v }) {
        return (
          <tr className="odd:bg-slate-50 even:bg-slate-100 dark:odd:bg-white/0 dark:even:bg-white/5">
            <td className="px-4 py-3 text-slate-600 dark:text-slate-300 w-1/3">
              {k}
            </td>
            <td className="px-4 py-3 text-slate-900 dark:text-slate-100">
              {v}
            </td>
          </tr>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
