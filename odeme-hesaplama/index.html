<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Ödeme Hesaplama</title>
    <meta name="color-scheme" content="light dark" />

    <!-- Tailwind (must set darkMode:'class' BEFORE loading CDN) -->
    <script>
      window.tailwind = { config: { darkMode: "class" } };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/tr.js"></script>

    <style>
      /* --- Flatpickr theming (consistent across light/dark) --- */

      /* Calendar surface (dark) */
      .dark .flatpickr-calendar {
        background: #0b1220;
        border: 1px solid rgba(255, 255, 255, 0.15);
      }
      .dark .flatpickr-months,
      .dark .flatpickr-weekdays { background: transparent; }

      /* Base header/text colors via currentColor */
      .flatpickr-calendar { color: #0f172a; }           /* light header text => slate-900 */
      .dark .flatpickr-calendar { color: #e5e7eb; }     /* dark header text  => slate-200 */

      .dark .flatpickr-current-month,
      .dark .flatpickr-weekday,
      .dark .flatpickr-day { color: #e5e7eb; }

      .dark .flatpickr-day.disabled,
      .dark .flatpickr-day.prevMonthDay,
      .dark .flatpickr-day.nextMonthDay { color: #64748b; }
      .dark .flatpickr-day:hover { background: rgba(34, 211, 238, 0.15); }
      .dark .flatpickr-day.inRange {
        background: rgba(34, 211, 238, 0.08);
        border-color: transparent;
      }
      .dark .flatpickr-day.selected,
      .dark .flatpickr-day.startRange,
      .dark .flatpickr-day.endRange,
      .dark .flatpickr-day.selected:hover {
        background: rgba(34, 211, 238, 0.9);
        color: #0b1220;
      }

      /* Inputs & month label colors inherit */
      .flatpickr-current-month .cur-year,
      .flatpickr-current-month .cur-month,
      .flatpickr-current-month .numInputWrapper input {
        color: inherit;
      }

      /* Month nav arrows use currentColor in both modes */
      .flatpickr-prev-month,
      .flatpickr-next-month { color: inherit; }
      .flatpickr-prev-month svg,
      .flatpickr-next-month svg { fill: currentColor !important; stroke: none !important; }

      /* Year increment/decrement arrows (consistent both modes) */
      .flatpickr-current-month .numInputWrapper .arrowUp,
      .flatpickr-current-month .numInputWrapper .arrowDown {
        opacity: 1;
        width: 18px;
        height: 50%;
      }
      .flatpickr-current-month .numInputWrapper .arrowUp:after { border-bottom-color: currentColor !important; }
      .flatpickr-current-month .numInputWrapper .arrowDown:after { border-top-color: currentColor !important; }

      /* Slightly clearer hover for days in light mode */
      .flatpickr-day:not(.selected):hover { background: rgba(14, 165, 233, 0.12); } /* cyan-500/12 */
      /* --- FIX: Dark mode month nav arrows visible --- */
.dark .flatpickr-months .flatpickr-prev-month,
.dark .flatpickr-months .flatpickr-next-month {
  /* force a light icon color on dark bg */
  color: #e5e7eb !important;              /* slate-200 */
}

.dark .flatpickr-months .flatpickr-prev-month svg,
.dark .flatpickr-months .flatpickr-next-month svg {
  fill: currentColor !important;
  stroke: none !important;
}

/* Optional: subtle hover so you can see it responds */
.dark .flatpickr-months .flatpickr-prev-month:hover,
.dark .flatpickr-months .flatpickr-next-month:hover {
  background-color: rgba(255,255,255,0.08);
  border-radius: 6px;
}

/* In case Flatpickr injects disabled state styles */
.dark .flatpickr-months .flatpickr-prev-month.flatpickr-disabled,
.dark .flatpickr-months .flatpickr-next-month.flatpickr-disabled {
  color: #64748b !important;              /* slate-500 for disabled */
}

/* (You already handled year arrows via currentColor, but this keeps them crisp) */
.dark .flatpickr-current-month .numInputWrapper .arrowUp:after {
  border-bottom-color: #e5e7eb !important;
}
.dark .flatpickr-current-month .numInputWrapper .arrowDown:after {
  border-top-color: #e5e7eb !important;
}

    </style>
  </head>
  <body class="min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useMemo, useEffect, useRef } = React;

      /* ---------- Local-date helpers (NO UTC / NO toISOString) ---------- */
      function startOfDayLocal(d) {
        const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        x.setHours(0,0,0,0);
        return x;
      }
      function todayYMD() {
        const t = new Date();
        const y = t.getFullYear();
        const m = String(t.getMonth()+1).padStart(2, "0");
        const d = String(t.getDate()).padStart(2, "0");
        return `${y}-${m}-${d}`;
      }
      function parseYMD(ymd) {
        const [y, m, d] = ymd.split("-").map(Number);
        return new Date(y, (m||1)-1, d||1); // local
      }
      function formatYMDLocal(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth()+1).padStart(2, "0");
        const d = String(date.getDate()).padStart(2, "0");
        return `${y}-${m}-${d}`;
      }
      function addYearsLocal(date, years) {
        const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        d.setFullYear(d.getFullYear() + years);
        return d;
      }
      function diffDaysLocal(a, b) {
        const A = startOfDayLocal(a).getTime();
        const B = startOfDayLocal(b).getTime();
        const MS = 86400000;
        return Math.floor((B - A) / MS);
      }
      function formatDDMMYYYY(date) {
        const d = String(date.getDate()).padStart(2,"0");
        const m = String(date.getMonth()+1).padStart(2,"0");
        const y = date.getFullYear();
        return `${d}/${m}/${y}`;
      }

      /* ---------- Flatpickr hook (uses Date objects, outputs YYYY-MM-DD) ---------- */
      function useFlatpickr(ymd, onChangeYMD) {
        const ref = useRef(null);
        useEffect(() => {
          if (!ref.current) return;
          const initial = parseYMD(ymd); // local Date object
          const fp = flatpickr(ref.current, {
            dateFormat: "d/m/Y",            // shown to user
            defaultDate: initial,           // Date object avoids string parsing bugs
            locale: flatpickr.l10ns.tr,
            onChange: (dates) => {
              if (dates.length) {
                const picked = dates[0];    // local Date
                onChangeYMD(formatYMDLocal(picked)); // back to YYYY-MM-DD
              }
            },
          });
          return () => fp.destroy();
        }, []); // mount once
        return ref;
      }

      function App() {
        // Theme with persistence; Tailwind uses .dark class
        const prefersDark = typeof window !== "undefined"
          && window.matchMedia?.("(prefers-color-scheme: dark)").matches;
        const [theme, setTheme] = useState(() =>
          localStorage.getItem("odeme-theme") || (prefersDark ? "dark" : "light")
        );
        useEffect(() => {
          localStorage.setItem("odeme-theme", theme);
          document.documentElement.classList.toggle("dark", theme === "dark");
        }, [theme]);
        const isDark = theme === "dark";

        // Data (store as YYYY-MM-DD strings)
        const [amount, setAmount] = useState("");
        const [years, setYears] = useState("1");
        const [saleDate, setSaleDate] = useState(todayYMD());
        const [asOfDate, setAsOfDate] = useState(todayYMD());

        // Calendar refs
        const saleRef = useFlatpickr(saleDate, setSaleDate);
        const asOfRef  = useFlatpickr(asOfDate, setAsOfDate);

        const fmt    = new Intl.NumberFormat("tr-TR",{style:"currency",currency:"TRY",maximumFractionDigits:0});
        const fmtNum = new Intl.NumberFormat("tr-TR",{maximumFractionDigits:0});
        const pct = (n,d)=> d<=0?0:Math.min(100,Math.max(0,(n/d)*100));

        const result = useMemo(() => {
          const amountNum = Number((amount||"").toString().replace(/[^0-9.,-]/g,"").replace(/,/g,"."));
          if (!saleDate || !asOfDate || !amountNum || amountNum < 0) return null;

          const sale = parseYMD(saleDate);
          const asof = parseYMD(asOfDate);

          let yearsNum = parseInt(years||"1",10);
          if (isNaN(yearsNum) || yearsNum < 1) yearsNum = 1;

          const end = addYearsLocal(sale, yearsNum);

          const totalDays = Math.max(0, diffDaysLocal(sale, end));
          const elapsedRaw = diffDaysLocal(sale, asof);
          const elapsed = Math.min(Math.max(0, elapsedRaw), totalDays);
          const remainingDays = Math.max(0, totalDays - elapsed);

          const dailyRate = totalDays>0 ? amountNum/totalDays : 0;
          const recognized = dailyRate * elapsed;
          const remaining = Math.max(0, amountNum - recognized);

          return {
            totalDays, elapsed, remainingDays,
            dailyRate, recognized, remaining,
            endDate: end, sale, asof, amountNum
          };
        }, [amount, years, saleDate, asOfDate]);

        return (
          <div className={
            "min-h-screen w-full transition-colors " +
            (isDark
              ? "bg-gradient-to-br from-slate-950 via-slate-900 to-slate-800 text-slate-100"
              : "bg-gradient-to-br from-slate-200 via-slate-100 to-slate-50 text-slate-900")
          }>
            <header className="px-6 pt-8 pb-4">
              <div className="flex items-start justify-between gap-4">
                <div>
                  <h1 className="text-3xl md:text-4xl font-semibold tracking-tight">Ödeme Hesaplama</h1>
                  {/* Subtitle: edit this line as you like */}
                  <p className="mt-1 text-sm text-slate-600 dark:text-slate-400">
                    Ay hediyeleri veya ekstra satılan entegrasyonları hesaplamaya dahil etmeyin.
                  </p>
                </div>
                <button
                  onClick={() => setTheme(isDark ? "light" : "dark")}
                  className={
                    "select-none rounded-xl px-3 py-2 text-sm font-medium border transition " +
                    (isDark
                      ? "bg-white/10 border-white/10 hover:bg-white/20 text-slate-100"
                      : "bg-slate-50/90 border-slate-300 hover:bg-slate-100 text-slate-900 shadow-sm")
                  }
                  title={isDark ? "Açık tema" : "Koyu tema"}
                >
                  {isDark ? "☀️ Açık" : "🌙 Koyu"}
                </button>
              </div>
            </header>

            <main className="px-6 pb-12 grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
              {/* Inputs */}
              <section className="lg:col-span-1">
                <div className={
                  "rounded-2xl p-5 border shadow-2xl transition " +
                  (isDark
                    ? "backdrop-blur-xl bg-white/5 border-white/10 shadow-black/30"
                    : "bg-slate-50/90 border-slate-300 shadow-sm")
                }>
                  <h2 className="text-lg font-medium mb-4">Girdiler</h2>
                  <div className="space-y-4">
                    <div>
                      <label className={"block text-sm mb-1 " + (isDark ? "text-slate-300" : "text-slate-700")} htmlFor="amount">Satış Tutarı</label>
                      <input id="amount" type="number" min="0" inputMode="decimal" placeholder="örn. 365000"
                        value={amount} onChange={(e) => setAmount(e.target.value)}
                        className={
                          "w-full rounded-xl px-3 py-2 outline-none focus:ring-2 transition " +
                          (isDark
                            ? "bg-white/10 border border-white/10 focus:ring-cyan-400/50"
                            : "bg-slate-50 border border-slate-300 focus:ring-cyan-300")
                        } />
                    </div>

                    <div>
                      <label className={"block text-sm mb-1 " + (isDark ? "text-slate-300" : "text-slate-700")} htmlFor="years">Sözleşme Süresi (yıl)</label>
                      <input id="years" type="number" min="1" step="1" value={years}
                        onChange={(e) => setYears(e.target.value)}
                        className={
                          "w-full rounded-xl px-3 py-2 outline-none focus:ring-2 transition " +
                          (isDark
                            ? "bg-white/10 border border-white/10 focus:ring-cyan-400/50"
                            : "bg-slate-50 border border-slate-300 focus:ring-cyan-300")
                        } />
                      <p className={"text-xs mt-1 " + (isDark ? "text-slate-400" : "text-slate-500")}>
                        Tam yıl kullanın (1, 2, 3, …). Bitiş = satış tarihi + yıl.
                      </p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className={"block text-sm mb-1 " + (isDark ? "text-slate-300" : "text-slate-700")} htmlFor="saleDate">Satış Tarihi</label>
                        <input ref={saleRef} id="saleDate"
                          className={
                            "w-full rounded-xl px-3 py-2 outline-none focus:ring-2 transition cursor-pointer " +
                            (isDark
                              ? "bg-white/10 border border-white/10 focus:ring-cyan-400/50"
                              : "bg-slate-50 border border-slate-300 focus:ring-cyan-300")
                          } />
                      </div>
                      <div>
                        <label className={"block text-sm mb-1 " + (isDark ? "text-slate-300" : "text-slate-700")} htmlFor="asOfDate">Hesaplama Tarihi</label>
                        <input ref={asOfRef} id="asOfDate"
                          className={
                            "w-full rounded-xl px-3 py-2 outline-none focus:ring-2 transition cursor-pointer " +
                            (isDark
                              ? "bg-white/10 border border-white/10 focus:ring-cyan-400/50"
                              : "bg-slate-50 border border-slate-300 focus:ring-cyan-300")
                          } />
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              {/* Results */}
              <section className="lg:col-span-2">
                <div className={
                  "rounded-2xl p-5 border shadow-2xl transition " +
                  (isDark
                    ? "backdrop-blur-xl bg-white/5 border-white/10 shadow-black/30"
                    : "bg-slate-50/90 border-slate-300 shadow-sm")
                }>
                  <h2 className="text-lg font-medium mb-4">Sonuçlar</h2>

                  {!result ? (
                    <div className={isDark ? "text-slate-400" : "text-slate-600"}>Sonuçları görmek için tüm alanları doldurun.</div>
                  ) : (
                    <div className="space-y-6">
                      <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                        <KPI label="Sözleşme Tutarı" value={fmt.format(result.amountNum)} isDark={isDark} />
                        <KPI label="Kalan Tutar" value={fmt.format(Math.round(result.remaining))} highlight isDark={isDark} />
                        <KPI label="Bugüne Kadar Gelirleşen" value={fmt.format(Math.round(result.recognized))} isDark={isDark} />
                        <KPI label="Günlük Oran" value={fmt.format(Math.round(result.dailyRate))} isDark={isDark} />
                      </div>

                      <div>
                        <div className="flex items-end justify-between mb-2">
                          <span className={"text-sm " + (isDark ? "text-slate-300" : "text-slate-700")}>İlerleme</span>
                          <span className={"text-xs " + (isDark ? "text-slate-400" : "text-slate-600")}>
                            {fmtNum.format(result.elapsed)} / {fmtNum.format(result.totalDays)} gün (%{pct(result.elapsed, result.totalDays).toFixed(1)})
                          </span>
                        </div>
                        <div className={"h-3 w-full rounded-full overflow-hidden " + (isDark ? "bg-white/10" : "bg-slate-300/60")}>
                          <div className="h-3" style={{ width: pct(result.elapsed, result.totalDays) + "%", backgroundColor: "rgb(34 211 238 / 0.9)" }} />
                        </div>
                        <div className={"flex items-center justify-between text-xs mt-2 " + (isDark ? "text-slate-400" : "text-slate-600")}>
                          <span>{formatDDMMYYYY(result.sale)}</span>
                          <span>Bitiş: {formatDDMMYYYY(result.endDate)}</span>
                        </div>
                      </div>

                      <div className={"overflow-hidden rounded-xl border " + (isDark ? "border-white/10" : "border-slate-300")}>
                        <table className="w-full text-sm">
                          <tbody>
                            <Row k="Satış Tarihi"      v={formatDDMMYYYY(result.sale)}     isDark={isDark} />
                            <Row k="Hesaplama Tarihi"  v={formatDDMMYYYY(result.asof)}     isDark={isDark} />
                            <Row k="Sözleşme Bitişi"   v={formatDDMMYYYY(result.endDate)}  isDark={isDark} />
                            <Row k="Toplam Gün"        v={fmtNum.format(result.totalDays)}      isDark={isDark} />
                            <Row k="Geçen Gün"         v={fmtNum.format(result.elapsed)}        isDark={isDark} />
                            <Row k="Kalan Gün"         v={fmtNum.format(result.remainingDays)}  isDark={isDark} />
                            <Row k="Gelirleşen Tutar"  v={fmt.format(Math.round(result.recognized))} isDark={isDark} />
                            <Row k="Kalan Tutar"       v={fmt.format(Math.round(result.remaining))}  isDark={isDark} />
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}
                </div>
              </section>
            </main>
          </div>
        );
      }

      function KPI({ label, value, highlight=false, isDark }) {
        return (
          <div className={
            "rounded-2xl p-4 border transition " +
            (highlight
              ? (isDark ? "bg-cyan-500/10 border-white/10" : "bg-cyan-50 border-cyan-200")
              : (isDark ? "bg-white/5 border-white/10"     : "bg-slate-50/90 border-slate-300 shadow-sm"))
          }>
            <div className={"text-xs " + (isDark ? "text-slate-400" : "text-slate-600")}>{label}</div>
            <div className="text-xl md:text-2xl font-semibold mt-1 tracking-tight">{value}</div>
          </div>
        );
      }

      function Row({ k, v, isDark }) {
        return (
          <tr className={isDark ? "odd:bg-white/0 even:bg-white/5" : "odd:bg-slate-50 even:bg-slate-100"}>
            <td className={"px-4 py-3 w-1/3 " + (isDark ? "text-slate-300" : "text-slate-700")}>{k}</td>
            <td className={"px-4 py-3 " + (isDark ? "text-slate-100" : "text-slate-900")}>{v}</td>
          </tr>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
